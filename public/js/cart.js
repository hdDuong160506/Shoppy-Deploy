// ==========================================================
// cart.js - Phi√™n b·∫£n Safe Mode (Ch·ªëng Crash khi Init ch·∫≠m)
// ==========================================================

let CART_DATA = {}; 
let cart = JSON.parse(localStorage.getItem('cart_v1') || '{}');
const $ = sel => document.querySelector(sel);

function formatMoney(n) {
    return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + '‚Ç´';
}

// ==========================================================
// 1. KH·ªûI T·∫†O
// ==========================================================

async function initCartPage() {
    console.log("üöÄ Cart Page Initializing...");
    setupEventListeners();
    await loadCartData();
}

function setupEventListeners() {
    const listContainer = $('#cart-page-list');
    if (!listContainer) return;

    if (listContainer.dataset.eventAttached === "true") return;

    listContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-action');
        if (!btn) return;
        e.preventDefault();

        const action = btn.dataset.action;
        const key = btn.dataset.key;
        
        console.log(`üñ±Ô∏è Click: ${action} - SP: ${key}`);
        handleCartAction(action, key);
    });

    listContainer.dataset.eventAttached = "true";
}

// ==========================================================
// 2. LOGIC X·ª¨ L√ù
// ==========================================================

function handleCartAction(action, key) {
    if (action === 'increase') {
        cart[key] = (cart[key] || 0) + 1;
    } 
    else if (action === 'decrease') {
        cart[key] = (cart[key] || 0) - 1;
        if (cart[key] <= 0) delete cart[key];
    } 
    else if (action === 'remove') {
        if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) delete cart[key];
        else return;
    }
    saveCart();
}

// üî• H√ÄM SAVE CART (ƒê√É FIX L·ªñI CRASH undefined reading 'getSession')
function saveCart() {
    // 1. L∆∞u LocalStorage & Render ngay
    localStorage.setItem('cart_v1', JSON.stringify(cart));
    renderCartPage();

    // 2. Sync DB
    if (window.cartSyncTimeout) clearTimeout(window.cartSyncTimeout);

    window.cartSyncTimeout = setTimeout(async () => {
        // üõë CHECK K·ª∏: Ph·∫£i c√≥ supabase V√Ä ph·∫£i c√≥ .auth (Client x·ªãn)
        if (typeof supabase === 'undefined' || !supabase.auth) {
            console.warn("‚ö†Ô∏è Supabase ch∆∞a s·∫µn s√†ng (Init ch·∫≠m ho·∫∑c sai th·ª© t·ª± script). B·ªè qua Sync.");
            return;
        }

        try {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (session && session.user) {
                console.log("‚òÅÔ∏è ƒêang ƒë·ªìng b·ªô...");
                const freshCartData = JSON.parse(localStorage.getItem('cart_v1') || '{}');

                const { error: upsertError } = await supabase
                    .from('cart')
                    .upsert({ 
                        user_id: session.user.id, 
                        cart_data: freshCartData, 
                        updated_at: new Date()
                    }, { onConflict: 'user_id' });

                if (upsertError) console.error("‚ùå Sync L·ªói:", upsertError.message);
                else console.log("‚úÖ Sync Th√†nh c√¥ng!");
            }
        } catch (err) {
            console.error("üî• L·ªói Sync:", err);
        }
    }, 1000);
}

// ==========================================================
// 3. T·∫¢I DATA & RENDER
// ==========================================================

async function loadCartData() {
    // Check LocalStorage tr∆∞·ªõc
    if (Object.keys(cart).length === 0) {
        await trySyncFromDB();
        if (Object.keys(cart).length === 0) {
            renderEmptyCart();
            return;
        }
    } else {
        // Ch·∫°y ng·∫ßm check DB
        trySyncFromDB().then(hasNew => {
            if (hasNew) {
                console.log("‚ôªÔ∏è Reload data m·ªõi t·ª´ DB...");
                fetchProductDetails();
            }
        });
    }
    await fetchProductDetails();
}

// üî• H√ÄM SYNC CHECK (C≈®NG ƒê√É FIX L·ªñI CRASH)
async function trySyncFromDB() {
    // üõë CHECK K·ª∏: Tr√°nh crash n·∫øu supabase ch·ªâ l√† th∆∞ vi·ªán r·ªóng
    if (typeof supabase === 'undefined' || !supabase.auth) return false;

    try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) return false;

        const { data: dbCart } = await supabase
            .from('cart')
            .select('cart_data')
            .eq('user_id', session.user.id)
            .maybeSingle();

        if (dbCart?.cart_data) {
            const localStr = JSON.stringify(cart);
            const dbStr = JSON.stringify(dbCart.cart_data);
            if (localStr !== dbStr) {
                cart = dbCart.cart_data;
                localStorage.setItem('cart_v1', JSON.stringify(cart));
                return true; 
            }
        }
    } catch (e) { 
        // L·ªù ƒëi l·ªói nh·∫π
    }
    return false;
}

function renderCartPage() {
    const cartList = $('#cart-page-list');
    if (!cartList) return;

    const cartCount = Object.values(cart).reduce((s, q) => s + q, 0);
    let total = 0;

    if (cartCount === 0) { renderEmptyCart(); return; }
    if($('#cart-page-checkout')) $('#cart-page-checkout').disabled = false;
    
    cartList.innerHTML = '';

    Object.entries(cart).forEach(([key, qty]) => {
        const itemDetails = CART_DATA[key];
        if (!itemDetails) return;

        const storeInfo = itemDetails.stores[0];
        const price = storeInfo.ps_min_price_store || 0;
        const itemTotal = price * qty;
        total += itemTotal;

        let displayImage = itemDetails.product_image_url;
        if (storeInfo.product_images?.length > 0) {
            displayImage = storeInfo.product_images[0].ps_image_url;
        }

        const item = document.createElement('div');
        item.className = 'cart-page-item';
        
        item.innerHTML = `
          <div class="col-product">
            <input type="checkbox" checked style="margin-right: 10px;" />
            <img src="${displayImage}" alt="img" onerror="this.src='images/placeholder.jpg'" />
            <div class="product-info">
              <h4>${itemDetails.product_name}</h4>
              <div class="shop-info">üè™ ${storeInfo.store_name}</div>
            </div>
          </div>
          <div class="col-price text-center">${formatMoney(price)}</div>
          <div class="col-qty">
            <div class="qty-selector">
              <button class="qty-btn btn-action" data-action="decrease" data-key="${key}">-</button>
              <div class="qty-display">${qty}</div>
              <button class="qty-btn btn-action" data-action="increase" data-key="${key}">+</button>
            </div>
          </div>
          <div class="col-total text-center text-bold">${formatMoney(itemTotal)}</div>
          <div class="col-action text-right">
            <button class="delete-btn btn-action" data-action="remove" data-key="${key}">X√≥a</button>
          </div>
        `;
        cartList.appendChild(item);
    });

    $('#cart-page-total').innerHTML = `T·ªïng c·ªông (${cartCount} S·∫£n ph·∫©m): <span>${formatMoney(total)}</span>`;
}

async function fetchProductDetails() {
    const cartList = $('#cart-page-list');
    if (!CART_DATA || Object.keys(CART_DATA).length === 0) {
        cartList.innerHTML = '<div style="text-align:center; padding:30px;"><div class="spinner"></div><p>ƒêang t·∫£i...</p></div>';
    }
    try {
        const res = await fetch('/api/cart/details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cart: cart })
        });
        if (res.ok) {
            CART_DATA = await res.json();
            renderCartPage();
        } else {
            cartList.innerHTML = '<p style="color:red; text-align:center;">L·ªói t·∫£i s·∫£n ph·∫©m.</p>';
        }
    } catch (err) {
        cartList.innerHTML = '<p style="color:red; text-align:center;">L·ªói k·∫øt n·ªëi.</p>';
    }
}

function renderEmptyCart() {
    const list = $('#cart-page-list');
    if(list) list.innerHTML = '<div class="empty-cart">Gi·ªè tr·ªëng <br><a href="index.html">Ti·∫øp t·ª•c mua s·∫Øm</a></div>';
    const totalEl = $('#cart-page-total');
    if(totalEl) totalEl.innerHTML = `T·ªïng c·ªông (0 S·∫£n ph·∫©m): <span>0‚Ç´</span>`;
    if($('#cart-page-checkout')) $('#cart-page-checkout').disabled = true;
}

const checkoutBtn = $('#cart-page-checkout');
if (checkoutBtn) {
    checkoutBtn.addEventListener('click', () => {
        const count = Object.values(cart).reduce((s, q) => s + q, 0);
        if (count === 0) { alert('Gi·ªè h√†ng tr·ªëng!'); return; }
        window.location.href = 'checkout.html';
    });
}

window.onload = initCartPage;

// Fallback
window.changeQty = function (key, delta) { handleCartAction(delta > 0 ? 'increase' : 'decrease', key); }
window.removeItem = function (key) { handleCartAction('remove', key); }